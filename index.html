<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portland Places</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png?v=2">
  <link rel="apple-touch-icon-precomposed" sizes="180x180" href="apple-touch-icon.png?v=2">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    
    #map { 
      position: absolute; 
      top: 0; 
      bottom: 0; 
      left: 0; 
      right: 0; 
    }
    
    .controls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      max-width: 200px;
    }
    
    .controls h3 {
      font-size: 14px;
      margin-bottom: 8px;
      color: #333;
    }
    
    .filter-group {
      margin-bottom: 12px;
    }
    
    .filter-group label {
      display: block;
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    
    .filter-group select {
      width: 100%;
      padding: 6px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }
    
    .legend {
      font-size: 11px;
      color: #666;
      margin-top: 12px;
      padding-top: 8px;
      border-top: 1px solid #eee;
    }
    
    .legend-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 4px 0;
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
      transition: background 0.15s;
    }
    
    .legend-item:hover {
      background: #f3f4f6;
    }
    
    .legend-item.active {
      background: #e5e7eb;
      font-weight: 500;
    }
    
    .legend-icon {
      width: 20px;
      text-align: center;
    }
    
    .count {
      font-size: 11px;
      color: #888;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #eee;
    }
    
    .locate-btn {
      width: 100%;
      padding: 8px 12px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-bottom: 12px;
    }
    
    .locate-btn:hover {
      background: #2563eb;
    }
    
    .locate-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    
    .locate-btn i {
      font-size: 12px;
    }
    
    /* Marker styles */
    .place-marker {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      font-size: 12px;
    }
    
    .place-marker i {
      color: white;
    }
    
    /* Status colors */
    .marker-haunts { background: #10b981; }
    .marker-queue { background: #3b82f6; }
    .marker-unknown { background: #9ca3af; }
    
    /* Popup styles */
    .popup-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .popup-meta {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    
    .popup-address {
      font-size: 11px;
      color: #888;
    }
    
    .popup-notes {
      font-size: 12px;
      color: #374151;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #e5e7eb;
      font-style: italic;
    }
    
    .popup-tags {
      margin-top: 6px;
    }
    
    .popup-tag {
      display: inline-block;
      background: #e5e7eb;
      color: #4b5563;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
      margin: 2px 2px 0 0;
    }
    
    .status-badge {
      display: inline-block;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
      margin-left: 6px;
    }
    
    .status-haunts { background: #d1fae5; color: #047857; }
    .status-queue { background: #dbeafe; color: #1d4ed8; }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <div class="controls">
    <h3>Portland Places</h3>
    
    <button class="locate-btn" id="locate-btn">
      <i class="fa-solid fa-location-crosshairs"></i>
      Find Me
    </button>
    
    <div class="filter-group">
      <label>Status</label>
      <select id="status-filter">
        <option value="all">All</option>
        <option value="haunts">üëª Haunts</option>
        <option value="queue">üìç Queue</option>
      </select>
    </div>
    
    <div class="filter-group">
      <label>Category</label>
      <select id="category-filter">
        <option value="all">All</option>
      </select>
    </div>
    
    <div class="filter-group" id="primary-filter-group" style="display:none;">
      <label>Food & Drink Type</label>
      <select id="primary-filter">
        <option value="all">All</option>
        <option value="coffee">‚òï Coffee</option>
        <option value="bar">üç∏ Bar</option>
        <option value="restaurant">üç¥ Restaurant</option>
      </select>
    </div>
    
    <div class="legend" id="status-legend">
      <div class="legend-title">Status (color)</div>
      <div class="legend-item" data-status="haunts"><span class="legend-icon" style="color:#10b981">‚óè</span> Haunts</div>
      <div class="legend-item" data-status="queue"><span class="legend-icon" style="color:#3b82f6">‚óè</span> Queue</div>
    </div>
    
    <div class="legend" id="category-legend">
      <div class="legend-title">Category (icon)</div>
      <div class="legend-item" data-category="Food & Drink"><span class="legend-icon"><i class="fa-solid fa-utensils"></i></span> Food & Drink</div>
      <div class="legend-item" data-category="Record Shops"><span class="legend-icon"><i class="fa-solid fa-record-vinyl"></i></span> Record Shops</div>
      <div class="legend-item" data-category="Bookstores"><span class="legend-icon"><i class="fa-solid fa-book"></i></span> Bookstores</div>
      <div class="legend-item" data-category="Movie Theaters"><span class="legend-icon"><i class="fa-solid fa-film"></i></span> Movie Theaters</div>
      <div class="legend-item" data-category="Provisions"><span class="legend-icon"><i class="fa-solid fa-cheese"></i></span> Provisions</div>
      <div class="legend-item" data-category="Supplies"><span class="legend-icon"><i class="fa-solid fa-screwdriver-wrench"></i></span> Supplies</div>
    </div>
    
    <div class="legend" id="primary-legend" style="display:none;">
      <div class="legend-title">Food & Drink Type</div>
      <div class="legend-item" data-primary="coffee"><span class="legend-icon"><i class="fa-solid fa-mug-hot"></i></span> Coffee</div>
      <div class="legend-item" data-primary="bar"><span class="legend-icon"><i class="fa-solid fa-martini-glass"></i></span> Bar</div>
      <div class="legend-item" data-primary="restaurant"><span class="legend-icon"><i class="fa-solid fa-utensils"></i></span> Restaurant</div>
    </div>
    
    <div class="count" id="count"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Initialize map centered on Portland
    const map = L.map('map').setView([45.52, -122.67], 12);
    
    // Add tile layer (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
    
    // Status colors
    const statusColors = {
      'haunts': '#10b981',
      'queue': '#3b82f6',
      'unknown': '#9ca3af'
    };
    
    // Category icons (Font Awesome classes)
    const categoryIcons = {
      'Food & Drink': 'fa-utensils',
      'Record Shop': 'fa-record-vinyl',
      'Record Shops': 'fa-record-vinyl',
      'Bookstore': 'fa-book',
      'Bookstores': 'fa-book',
      'Movie Theaters': 'fa-film',
      'Movie Theater': 'fa-film',
      'Provisions': 'fa-cheese',
      'Supplies': 'fa-screwdriver-wrench',
      'Arts & Culture': 'fa-palette',
      'Music Venues': 'fa-music',
      'Clothing': 'fa-shirt'
    };
    
    // Primary icons for Food & Drink subcategories
    const primaryIcons = {
      'coffee': 'fa-mug-hot',
      'bar': 'fa-martini-glass',
      'restaurant': 'fa-utensils'
    };
    
    // Create custom marker
    function createMarkerIcon(status, category, primary) {
      const color = statusColors[status] || statusColors.unknown;
      const statusClass = `marker-${status || 'unknown'}`;
      
      // Use primary icon for Food & Drink, otherwise use category icon
      let iconClass;
      if (category === 'Food & Drink' && primary && primaryIcons[primary]) {
        iconClass = primaryIcons[primary];
      } else {
        iconClass = categoryIcons[category] || 'fa-location-dot';
      }
      
      return L.divIcon({
        className: 'custom-marker',
        html: `<div class="place-marker ${statusClass}"><i class="fa-solid ${iconClass}"></i></div>`,
        iconSize: [28, 28],
        iconAnchor: [14, 14],
        popupAnchor: [0, -14]
      });
    }
    
    // Format popup content
    function formatPopup(props) {
      const statusClass = `status-${props.status}`;
      const statusLabels = { 'haunts': 'Haunt', 'queue': 'Queue' };
      const statusLabel = statusLabels[props.status] || '';
      
      let html = `
        <div class="popup-name">
          ${props.name}
          ${statusLabel ? `<span class="status-badge ${statusClass}">${statusLabel}</span>` : ''}
        </div>
        <div class="popup-meta">${props.category}</div>
      `;
      
      if (props.neighborhood) {
        html += `<div class="popup-meta">${props.neighborhood}</div>`;
      }
      
      if (props.address) {
        html += `<div class="popup-address">${props.address}</div>`;
      }
      
      const tags = [
        ...(props.type || []),
        ...(props.cuisine || []),
        ...(props.goodFor || [])
      ].filter(Boolean);
      
      if (tags.length > 0) {
        html += '<div class="popup-tags">';
        tags.forEach(tag => {
          html += `<span class="popup-tag">${tag}</span>`;
        });
        html += '</div>';
      }
      
      if (props.notes && typeof props.notes === 'string' && props.notes.trim()) {
        html += `<div class="popup-notes">${props.notes}</div>`;
      }
      
      return html;
    }
    
    // Store all markers and data
    let allPlaces = [];
    let markers = L.layerGroup().addTo(map);
    
    // Filter and render markers
    function renderMarkers() {
      const statusFilter = document.getElementById('status-filter').value;
      const categoryFilter = document.getElementById('category-filter').value;
      const primaryFilter = document.getElementById('primary-filter').value;
      
      // Show/hide primary filter based on category selection
      const primaryFilterGroup = document.getElementById('primary-filter-group');
      const primaryLegend = document.getElementById('primary-legend');
      const showPrimary = categoryFilter === 'Food & Drink' || categoryFilter === 'all';
      primaryFilterGroup.style.display = showPrimary ? 'block' : 'none';
      primaryLegend.style.display = (categoryFilter === 'Food & Drink') ? 'block' : 'none';
      
      markers.clearLayers();
      
      let count = 0;
      allPlaces.forEach(feature => {
        const props = feature.properties;
        const coords = feature.geometry.coordinates;
        
        // Apply filters
        if (statusFilter !== 'all' && props.status !== statusFilter) return;
        if (categoryFilter !== 'all' && props.category !== categoryFilter) return;
        
        // Apply primary filter (only for Food & Drink)
        if (primaryFilter !== 'all' && props.category === 'Food & Drink') {
          if (props.primary !== primaryFilter) return;
        }
        
        const marker = L.marker([coords[1], coords[0]], {
          icon: createMarkerIcon(props.status, props.category, props.primary)
        });
        
        marker.bindPopup(formatPopup(props), { maxWidth: 250 });
        markers.addLayer(marker);
        count++;
      });
      
      document.getElementById('count').textContent = `Showing ${count} of ${allPlaces.length}`;
    }
    
    // Load GeoJSON data
    fetch('places.geojson')
      .then(res => res.json())
      .then(data => {
        allPlaces = data.features;
        
        // Populate category filter
        const categories = [...new Set(allPlaces.map(f => f.properties.category))].sort();
        const categorySelect = document.getElementById('category-filter');
        categories.forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          opt.textContent = cat;
          categorySelect.appendChild(opt);
        });
        
        // Initial render
        renderMarkers();
        
        // Fit bounds to markers
        if (allPlaces.length > 0) {
          const bounds = L.latLngBounds(allPlaces.map(f => [
            f.geometry.coordinates[1], 
            f.geometry.coordinates[0]
          ]));
          map.fitBounds(bounds, { padding: [50, 50] });
        }
      })
      .catch(err => {
        console.error('Failed to load places:', err);
      });
    
    // Location tracking
    let userMarker = null;
    let userCircle = null;
    
    const locateBtn = document.getElementById('locate-btn');
    
    locateBtn.addEventListener('click', () => {
      locateBtn.disabled = true;
      locateBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Locating...';
      
      map.locate({ setView: true, maxZoom: 15, enableHighAccuracy: true });
    });
    
    map.on('locationfound', (e) => {
      const radius = e.accuracy / 2;
      
      // Remove old markers
      if (userMarker) map.removeLayer(userMarker);
      if (userCircle) map.removeLayer(userCircle);
      
      // Add new markers
      userMarker = L.marker(e.latlng, {
        icon: L.divIcon({
          className: 'user-location',
          html: '<div style="width:16px;height:16px;background:#3b82f6;border:3px solid white;border-radius:50%;box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>',
          iconSize: [16, 16],
          iconAnchor: [8, 8]
        })
      }).addTo(map).bindPopup("You are here").openPopup();
      
      userCircle = L.circle(e.latlng, { radius, color: '#3b82f6', fillColor: '#3b82f6', fillOpacity: 0.15, weight: 1 }).addTo(map);
      
      locateBtn.disabled = false;
      locateBtn.innerHTML = '<i class="fa-solid fa-location-crosshairs"></i> Find Me';
    });
    
    map.on('locationerror', (e) => {
      alert('Could not get location: ' + e.message);
      locateBtn.disabled = false;
      locateBtn.innerHTML = '<i class="fa-solid fa-location-crosshairs"></i> Find Me';
    });
    
    // Filter event listeners
    document.getElementById('status-filter').addEventListener('change', () => {
      updateLegendActive();
      renderMarkers();
    });
    document.getElementById('category-filter').addEventListener('change', () => {
      // Reset primary filter when category changes
      document.getElementById('primary-filter').value = 'all';
      updateLegendActive();
      renderMarkers();
    });
    document.getElementById('primary-filter').addEventListener('change', () => {
      updateLegendActive();
      renderMarkers();
    });
    
    // Update legend active states based on current filter
    function updateLegendActive() {
      const statusFilter = document.getElementById('status-filter').value;
      const categoryFilter = document.getElementById('category-filter').value;
      const primaryFilter = document.getElementById('primary-filter').value;
      
      // Status legend
      document.querySelectorAll('#status-legend .legend-item').forEach(item => {
        const status = item.dataset.status;
        item.classList.toggle('active', status === statusFilter);
      });
      
      // Category legend
      document.querySelectorAll('#category-legend .legend-item').forEach(item => {
        const category = item.dataset.category;
        item.classList.toggle('active', category === categoryFilter);
      });
      
      // Primary legend
      document.querySelectorAll('#primary-legend .legend-item').forEach(item => {
        const primary = item.dataset.primary;
        item.classList.toggle('active', primary === primaryFilter);
      });
    }
    
    // Legend click handlers
    document.querySelectorAll('#status-legend .legend-item').forEach(item => {
      item.addEventListener('click', () => {
        const status = item.dataset.status;
        const select = document.getElementById('status-filter');
        // Toggle: if already selected, reset to 'all'
        select.value = select.value === status ? 'all' : status;
        updateLegendActive();
        renderMarkers();
      });
    });
    
    document.querySelectorAll('#category-legend .legend-item').forEach(item => {
      item.addEventListener('click', () => {
        const category = item.dataset.category;
        const select = document.getElementById('category-filter');
        // Toggle: if already selected, reset to 'all'
        select.value = select.value === category ? 'all' : category;
        // Reset primary filter when category changes
        document.getElementById('primary-filter').value = 'all';
        updateLegendActive();
        renderMarkers();
      });
    });
    
    document.querySelectorAll('#primary-legend .legend-item').forEach(item => {
      item.addEventListener('click', () => {
        const primary = item.dataset.primary;
        const select = document.getElementById('primary-filter');
        // Toggle: if already selected, reset to 'all'
        select.value = select.value === primary ? 'all' : primary;
        updateLegendActive();
        renderMarkers();
      });
    });
  </script>
</body>
</html>
