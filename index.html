<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portland Places</title>
  <meta name="description" content="@hansef's Personal atlas of Portland">
  <meta name="theme-color" content="#10b981">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="PDX Places">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png?v=2">
  <link rel="apple-touch-icon-precomposed" sizes="180x180" href="apple-touch-icon.png?v=2">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,500;9..144,600&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <!-- Load shared config before Alpine (makes window.PlacesConfig available) -->
  <script src="shared.js"></script>
  <script>
    // Access shared config from window.PlacesConfig (loaded by shared.js)
    const { categoryIcons, primaryIcons, getPlaceIcon, slugify, encodeFilterHash, formatWebsiteDisplay, getOpenStatus } = window.PlacesConfig;

    // Register Alpine store BEFORE Alpine initializes
    document.addEventListener('alpine:init', () => {
      Alpine.store('app', {
        // Data
        places: [],
        categories: [],

        // Filter state
        filter: {
          status: 'all',
          category: 'all',
          primary: 'all',
          openNow: false,
          search: ''
        },

        // UI state
        ui: {
          filterPanelOpen: false,
          listSidebarOpen: false,
          locating: false,
          placeCount: 0,
          loadError: null
        },

        // Computed
        get hasActiveFilters() {
          return this.filter.status !== 'all' ||
                 this.filter.category !== 'all' ||
                 this.filter.primary !== 'all' ||
                 this.filter.openNow ||
                 this.filter.search !== '';
        },

        get showPrimaryFilter() {
          return this.filter.category === 'Food & Drink';
        },

        get filterChips() {
          const capitalize = s => s.charAt(0).toUpperCase() + s.slice(1);
          const chips = [];

          // Search chip first (if active)
          if (this.filter.search) {
            const truncated = this.filter.search.length > 15
              ? this.filter.search.slice(0, 15) + '…'
              : this.filter.search;
            chips.push({ type: 'search', value: this.filter.search, label: `"${truncated}"`, icon: 'fa-magnifying-glass', class: 'search-chip' });
          }
          if (this.filter.openNow) {
            chips.push({ type: 'openNow', value: true, label: 'Open Now', icon: 'fa-clock', class: 'open-now-chip', hasDot: true });
          }
          if (this.filter.status !== 'all') {
            const status = this.filter.status;
            chips.push({ type: 'status', value: status, label: capitalize(status), icon: status === 'haunts' ? 'fa-heart' : 'fa-bookmark', class: `status-${status}` });
          }
          if (this.filter.category !== 'all') {
            chips.push({ type: 'category', value: this.filter.category, label: this.filter.category, icon: categoryIcons[this.filter.category] || 'fa-location-dot', class: '' });
          }
          if (this.filter.primary !== 'all' && this.filter.category === 'Food & Drink') {
            chips.push({ type: 'primary', value: this.filter.primary, label: capitalize(this.filter.primary), icon: primaryIcons[this.filter.primary] || 'fa-utensils', class: '' });
          }

          return chips;
        },

        // Helper methods
        getCategoryIcon(category) {
          return categoryIcons[category] || 'fa-location-dot';
        },

        getPlaceIconClass(props) {
          return getPlaceIcon(props.category, props.primary);
        },

        getPlacesInCategory(category) {
          // Filter places by category first
          let filtered = this.places.filter(f => f.properties.category === category);

          // Apply current filters (status, primary, openNow) - uses window._filterPlaces set by app.js
          if (window._filterPlaces) {
            filtered = window._filterPlaces(filtered, this.filter);
          }

          // Apply search if present
          if (this.filter.search && window._searchPlaces) {
            filtered = window._searchPlaces(filtered, this.filter.search);
          }

          // Map to objects with original index (for jumpToPlace) and sort
          return filtered
            .map(feature => ({ feature, index: this.places.indexOf(feature) }))
            .sort((a, b) => a.feature.properties.name.localeCompare(b.feature.properties.name));
        },

        // Get categories that have places after filtering
        get filteredCategories() {
          return this.categories.filter(cat => this.getPlacesInCategory(cat).length > 0);
        },

        // Actions
        applyFilter() {
          if (window._mapApp) {
            window._mapApp.renderMarkers();
          }
          this.updateHash();
        },

        setStatus(status) {
          this.filter.status = status;
          this.applyFilter();
        },

        setCategory(category) {
          this.filter.category = category;
          if (category !== 'Food & Drink') {
            this.filter.primary = 'all';
          }
          this.applyFilter();
        },

        setPrimary(primary) {
          this.filter.primary = primary;
          this.applyFilter();
        },

        toggleOpenNow() {
          this.filter.openNow = !this.filter.openNow;
          this.applyFilter();
        },

        resetFilters() {
          this.filter.status = 'all';
          this.filter.category = 'all';
          this.filter.primary = 'all';
          this.filter.openNow = false;
          this.filter.search = '';
        },

        clearFilters() {
          this.resetFilters();
          if (window._mapApp) {
            window._mapApp.renderMarkers();
          }
          history.replaceState(null, '', window.location.pathname + window.location.search);
        },

        setSearch(query) {
          this.filter.search = query;
          this.applyFilter();
        },

        clearSearch() {
          this.filter.search = '';
          this.applyFilter();
        },

        removeFilterChip(chip) {
          switch (chip.type) {
            case 'search':
              this.clearSearch();
              break;
            case 'openNow':
              this.toggleOpenNow();
              break;
            case 'status':
              this.setStatus('all');
              break;
            case 'category':
              this.setCategory('all');
              break;
            case 'primary':
              this.setPrimary('all');
              break;
          }
        },

        updateHash() {
          const hash = encodeFilterHash(this.filter);
          history.replaceState(null, '', window.location.pathname + window.location.search + hash);
        },

        toggleFilterPanel() {
          if (this.ui.listSidebarOpen) {
            this.ui.listSidebarOpen = false;
          }
          this.ui.filterPanelOpen = !this.ui.filterPanelOpen;
        },

        closeFilterPanel() {
          this.ui.filterPanelOpen = false;
        },

        toggleListSidebar() {
          if (this.ui.filterPanelOpen) {
            this.ui.filterPanelOpen = false;
          }
          this.ui.listSidebarOpen = !this.ui.listSidebarOpen;
        },

        closeListSidebar() {
          this.ui.listSidebarOpen = false;
        },

        closeAllPanels() {
          this.ui.filterPanelOpen = false;
          this.ui.listSidebarOpen = false;
        },

        jumpToPlace(index) {
          this.closeAllPanels();
          // Don't reset filters - keep search/filter state when clicking from filtered list
          if (window._mapApp) {
            window._mapApp.jumpToPlace(index);
          }
        },

        locateUser() {
          this.ui.locating = true;
          if (window._mapApp) {
            window._mapApp.locateUser();
          }
        }
      });
    });
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.14.3/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js"></script>
</head>
<body x-data="$store.app">
  <div id="map"></div>

  <!-- Error message -->
  <div class="load-error" x-show="ui.loadError" x-cloak>
    <i class="fa-solid fa-triangle-exclamation"></i>
    <span x-text="ui.loadError"></span>
  </div>

  <!-- Overlay for panels -->
  <div class="filter-overlay"
       :class="{ 'visible': ui.filterPanelOpen || ui.listSidebarOpen }"
       @click="closeAllPanels()"></div>

  <!-- List toggle button -->
  <button class="list-toggle-btn"
          :class="{ 'active': ui.listSidebarOpen }"
          @click="toggleListSidebar()"
          title="View all places">
    <i class="fa-solid fa-list"></i>
  </button>

  <!-- List sidebar -->
  <div class="list-sidebar" :class="{ 'expanded': ui.listSidebarOpen }">
    <div class="list-sidebar-header">
      <div class="list-sidebar-title-row">
        <h2 class="list-sidebar-title" x-text="ui.placeCount + ' Places'"></h2>
        <button class="list-sidebar-close" @click="closeListSidebar()">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <!-- Search input -->
      <div class="list-search-container">
        <i class="fa-solid fa-magnifying-glass list-search-icon"></i>
        <input type="search"
               x-model="filter.search"
               @input.debounce.150ms="applyFilter()"
               placeholder="Search places..."
               class="list-search-input"
               aria-label="Search places">
        <button class="list-search-clear"
                x-show="filter.search"
                @click="clearSearch()"
                title="Clear search">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <!-- Active filter chips (removable) -->
      <div class="list-filter-chips" x-show="filterChips.length > 0">
        <template x-for="chip in filterChips" :key="chip.type + chip.value">
          <button class="list-filter-chip"
                  :class="chip.class"
                  @click="removeFilterChip(chip)"
                  :title="'Remove ' + chip.label + ' filter'">
            <span x-show="chip.hasDot" class="chip-dot"></span>
            <i x-show="!chip.hasDot" class="fa-solid" :class="chip.icon"></i>
            <span x-text="chip.label"></span>
            <i class="fa-solid fa-xmark chip-remove"></i>
          </button>
        </template>
      </div>
    </div>

    <div class="list-sidebar-content" id="list-sidebar-content">
      <!-- Empty state -->
      <div class="list-empty-state" x-show="filteredCategories.length === 0">
        <i class="fa-solid fa-magnifying-glass"></i>
        <p>No places match your search</p>
        <button class="list-empty-clear" @click="clearFilters()">Clear filters</button>
      </div>

      <!-- Categories rendered by Alpine (only show categories with results) -->
      <!-- Auto-expand categories when searching, collapse when search is cleared -->
      <template x-for="category in filteredCategories" :key="category">
        <div class="list-category" x-data="{ expanded: false }" x-effect="expanded = $store.app.filter.search !== ''">
          <button class="list-category-header" @click="expanded = !expanded">
            <i class="fa-solid" :class="getCategoryIcon(category)"></i>
            <span class="list-category-title" x-text="category"></span>
            <span class="list-category-count" x-text="getPlacesInCategory(category).length"></span>
            <i class="fa-solid fa-chevron-down list-category-chevron"
               :style="expanded ? 'transform: rotate(180deg)' : ''"></i>
          </button>
          <div class="list-category-items" x-show="expanded" x-collapse>
            <template x-for="item in getPlacesInCategory(category)" :key="item.index">
              <button class="list-item" @click="jumpToPlace(item.index)">
                <div class="list-item-icon"
                     :class="item.feature.properties.status === 'haunts' ? 'haunts' : item.feature.properties.status === 'queue' ? 'queue' : ''">
                  <i class="fa-solid" :class="getPlaceIconClass(item.feature.properties)"></i>
                </div>
                <div class="list-item-content">
                  <div class="list-item-name" x-text="item.feature.properties.name"></div>
                  <div class="list-item-meta" x-text="item.feature.properties.neighborhood || item.feature.properties.category"></div>
                </div>
                <span class="status-badge"
                      x-show="item.feature.properties.status === 'haunts' || item.feature.properties.status === 'queue'"
                      :class="'status-' + item.feature.properties.status"
                      x-text="item.feature.properties.status === 'haunts' ? 'Haunt' : 'Queue'"></span>
              </button>
            </template>
          </div>
        </div>
      </template>
    </div>
  </div>

  <!-- Filter bar -->
  <div class="filter-bar" :class="{ 'expanded': ui.filterPanelOpen }">
    <div class="filter-bar-header" @click="toggleFilterPanel()">
      <div class="filter-bar-toggle">
        <i class="fa-solid fa-sliders"></i>
      </div>
      <span class="filter-bar-title">Filters</span>

      <!-- Collapsed state: show chips when filters active (search chip included in filterChips) -->
      <div class="filter-bar-chips" x-show="!ui.filterPanelOpen && filterChips.length > 0">
        <template x-for="chip in filterChips" :key="chip.type + chip.value">
          <span class="filter-bar-chip" :class="chip.class">
            <span x-show="chip.hasDot" class="chip-dot"></span>
            <i x-show="!chip.hasDot" class="fa-solid" :class="chip.icon"></i>
            <span x-text="chip.label"></span>
          </span>
        </template>
      </div>

      <div class="filter-bar-count" x-show="!ui.filterPanelOpen" x-text="ui.placeCount + ' places'"></div>

      <button class="filter-bar-clear"
              :class="{ 'visible': hasActiveFilters && !ui.filterPanelOpen }"
              @click.stop="clearFilters()"
              title="Clear filters">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <!-- Expanded filter panel -->
    <div class="filter-panel" @click.stop>
      <!-- Open Now toggle -->
      <div class="open-now-section"
           :class="{ 'active': filter.openNow }"
           @click="toggleOpenNow()">
        <div class="open-now-label">
          <div class="open-now-icon">
            <i class="fa-solid fa-clock"></i>
          </div>
          <div class="open-now-text">
            <span class="open-now-title">Open Now</span>
            <span class="open-now-subtitle">Show only places currently open</span>
          </div>
        </div>
        <div class="open-toggle" :class="{ 'active': filter.openNow }"></div>
      </div>

      <!-- Search input -->
      <div class="filter-search-container">
        <i class="fa-solid fa-magnifying-glass filter-search-icon"></i>
        <input type="search"
               x-model="filter.search"
               @input.debounce.150ms="applyFilter()"
               placeholder="Search places..."
               class="filter-search-input"
               aria-label="Search places">
        <button class="filter-search-clear"
                x-show="filter.search"
                @click="clearSearch()"
                title="Clear search">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <!-- Status filter -->
      <div class="filter-section">
        <div class="filter-section-header">
          <span class="filter-section-title">Status</span>
        </div>
        <div class="filter-pills">
          <button class="filter-pill"
                  :class="{ 'active': filter.status === 'all' }"
                  @click="setStatus('all')">All</button>
          <button class="filter-pill"
                  :class="{ 'active': filter.status === 'haunts' }"
                  data-status="haunts"
                  @click="setStatus('haunts')">
            <i class="fa-solid fa-heart"></i> Haunts
          </button>
          <button class="filter-pill"
                  :class="{ 'active': filter.status === 'queue' }"
                  data-status="queue"
                  @click="setStatus('queue')">
            <i class="fa-solid fa-bookmark"></i> Queue
          </button>
        </div>
      </div>

      <!-- Category filter -->
      <div class="filter-section">
        <div class="filter-section-header">
          <span class="filter-section-title">Category</span>
        </div>
        <div class="filter-pills">
          <button class="filter-pill"
                  :class="{ 'active': filter.category === 'all' }"
                  @click="setCategory('all')">All</button>
          <template x-for="cat in categories" :key="cat">
            <button class="filter-pill"
                    :class="{ 'active': filter.category === cat }"
                    @click="setCategory(cat)">
              <i class="fa-solid" :class="getCategoryIcon(cat)"></i>
              <span x-text="cat"></span>
            </button>
          </template>
        </div>
      </div>

      <!-- Primary filter (Food & Drink only) -->
      <div class="filter-section primary-section" :class="{ 'visible': showPrimaryFilter }">
        <div class="filter-section-header">
          <span class="filter-section-title">Type</span>
        </div>
        <div class="filter-pills">
          <button class="filter-pill"
                  :class="{ 'active': filter.primary === 'all' }"
                  @click="setPrimary('all')">All</button>
          <button class="filter-pill"
                  :class="{ 'active': filter.primary === 'coffee' }"
                  @click="setPrimary('coffee')">
            <i class="fa-solid fa-mug-hot"></i> Coffee
          </button>
          <button class="filter-pill"
                  :class="{ 'active': filter.primary === 'bar' }"
                  @click="setPrimary('bar')">
            <i class="fa-solid fa-martini-glass"></i> Bar
          </button>
          <button class="filter-pill"
                  :class="{ 'active': filter.primary === 'restaurant' }"
                  @click="setPrimary('restaurant')">
            <i class="fa-solid fa-utensils"></i> Restaurant
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup Template (cloned by app.js for Leaflet marker popups) -->
  <!-- Each popup gets its own 'place' data via x-data, set by createPopupElement() -->
  <template id="popup-template">
    <div class="popup-content" x-data="{ hoursExpanded: false, place: {} }">
      <div class="popup-name" x-text="place.name"></div>

      <!-- Badge row: Haunt/Queue + Open Status -->
      <div class="popup-badges">
        <span x-show="place.status === 'haunts' || place.status === 'queue'"
              class="status-badge"
              :class="'status-' + place.status"
              x-text="place.status === 'haunts' ? 'Haunt' : 'Queue'"></span>
        <span x-show="place.openStatus === 'open'"
              class="open-status is-open">
          <span class="status-dot"></span>
          Open
        </span>
        <span x-show="place.openStatus === 'closing-soon'"
              class="open-status closing-soon">
          <span class="status-dot"></span>
          Closing Soon
        </span>
        <span x-show="place.openStatus === 'closed'"
              class="open-status is-closed">
          Closed
        </span>
      </div>

      <div class="popup-meta"
           x-text="[place.category, place.neighborhood].filter(Boolean).join(' · ')"></div>
      <div class="popup-address"
           x-show="place.address"
           x-text="place.address"></div>

      <!-- Website link -->
      <div class="popup-website" x-show="place.website">
        <a :href="place.website"
           target="_blank"
           rel="noopener"
           x-text="place.websiteDisplay"></a>
      </div>

      <!-- Hours section -->
      <div class="popup-hours" x-show="place.hours?.length > 0">
        <div class="popup-hours-row">
          <span class="popup-hours-day" x-text="place.todayName"></span>
          <span class="popup-hours-time" x-text="place.todayHours"></span>
        </div>
        <!-- Closing soon / Opens at note -->
        <div class="popup-hours-note"
             x-show="place.isClosingSoon"
             x-text="'Closes in ' + place.minutesUntilClose + ' min'"></div>
        <div class="popup-hours-note"
             x-show="place.openStatus === 'closed' && place.opensAt"
             x-text="'Opens ' + place.opensAt"></div>

        <!-- All hours (collapsible) -->
        <div class="popup-hours-list" :class="{ 'expanded': hoursExpanded }">
          <template x-for="day in (place.orderedHours || [])" :key="day.name">
            <div class="popup-hours-row" :class="{ 'today': day.isToday }">
              <span class="popup-hours-day" x-text="day.name.slice(0, 3)"></span>
              <span x-text="day.time"></span>
            </div>
          </template>
        </div>

        <button class="popup-hours-toggle"
                @click="hoursExpanded = !hoursExpanded"
                x-text="hoursExpanded ? 'Hide hours' : 'Show all hours'"></button>
      </div>

      <!-- Tags -->
      <div class="popup-tags" x-show="place.tags?.length > 0">
        <template x-for="tag in (place.tags || [])" :key="tag">
          <span class="popup-tag" x-text="tag"></span>
        </template>
      </div>

      <!-- Notes -->
      <div class="popup-notes"
           x-show="place.notes"
           x-text="place.notes"></div>
    </div>
  </template>

  <!-- Locate button -->
  <button class="locate-btn"
          :disabled="ui.locating"
          @click="locateUser()"
          title="Find my location">
    <i class="fa-solid" :class="ui.locating ? 'fa-spinner fa-spin' : 'fa-location-crosshairs'"></i>
  </button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/minisearch@7.1.1/dist/umd/index.min.js"></script>
  <script type="module">
    import { init } from './app.js';
    // Initialize the map app (Alpine store is already registered in head)
    init();
  </script>
</body>
</html>
