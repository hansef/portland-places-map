<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portland Places</title>
  <meta name="description" content="@hansef's Personal atlas of Portland">
  <meta name="theme-color" content="#10b981">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="PDX Places">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png?v=2">
  <link rel="apple-touch-icon-precomposed" sizes="180x180" href="apple-touch-icon.png?v=2">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,400;9..144,500;9..144,600&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script>
    // Import config objects - must be duplicated here since this runs before modules
    const categoryIcons = {
      'Food & Drink': 'fa-utensils',
      'Record Shop': 'fa-record-vinyl',
      'Record Shops': 'fa-record-vinyl',
      'Bookstore': 'fa-book',
      'Bookstores': 'fa-book',
      'Movie Theaters': 'fa-film',
      'Movie Theater': 'fa-film',
      'Provisions': 'fa-cheese',
      'Supplies': 'fa-screwdriver-wrench',
      'Arts & Culture': 'fa-palette',
      'Music Venues': 'fa-music',
      'Clothing': 'fa-shirt'
    };

    const primaryIcons = {
      'coffee': 'fa-mug-hot',
      'bar': 'fa-martini-glass',
      'restaurant': 'fa-utensils'
    };

    function getPlaceIcon(category, primary) {
      if (category === 'Food & Drink' && primary && primaryIcons[primary]) {
        return primaryIcons[primary];
      }
      return categoryIcons[category] || 'fa-location-dot';
    }

    function slugify(name) {
      return name.toLowerCase().replace(/['']/g, '').replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
    }

    function encodeFilterHash(filterState) {
      const parts = [];
      const hasCategory = filterState.category !== 'all';
      const hasPrimary = filterState.primary !== 'all' && filterState.category === 'Food & Drink';
      if (filterState.status !== 'all') {
        parts.push(filterState.status);
      } else if (hasCategory || hasPrimary) {
        parts.push('all');
      }
      if (hasCategory) {
        parts.push(slugify(filterState.category));
      } else if (hasPrimary) {
        parts.push(slugify('Food & Drink'));
      }
      if (hasPrimary) {
        parts.push(filterState.primary);
      }
      return parts.length > 0 ? '#' + parts.join('/') : '';
    }

    // Register Alpine store BEFORE Alpine initializes
    document.addEventListener('alpine:init', () => {
      Alpine.store('app', {
        // Data
        places: [],
        categories: [],

        // Filter state
        filter: {
          status: 'all',
          category: 'all',
          primary: 'all'
        },

        // UI state
        ui: {
          filterPanelOpen: false,
          listSidebarOpen: false,
          locating: false,
          placeCount: 0,
          loadError: null
        },

        // Computed
        get hasActiveFilters() {
          return this.filter.status !== 'all' ||
                 this.filter.category !== 'all' ||
                 this.filter.primary !== 'all';
        },

        get showPrimaryFilter() {
          return this.filter.category === 'Food & Drink';
        },

        get filterChips() {
          const chips = [];
          if (this.filter.status !== 'all') {
            chips.push({
              type: 'status',
              value: this.filter.status,
              label: this.filter.status.charAt(0).toUpperCase() + this.filter.status.slice(1),
              icon: this.filter.status === 'haunts' ? 'fa-heart' : 'fa-bookmark',
              class: `status-${this.filter.status}`
            });
          }
          if (this.filter.category !== 'all') {
            chips.push({
              type: 'category',
              value: this.filter.category,
              label: this.filter.category,
              icon: categoryIcons[this.filter.category] || 'fa-location-dot',
              class: ''
            });
          }
          if (this.filter.primary !== 'all' && this.filter.category === 'Food & Drink') {
            chips.push({
              type: 'primary',
              value: this.filter.primary,
              label: this.filter.primary.charAt(0).toUpperCase() + this.filter.primary.slice(1),
              icon: primaryIcons[this.filter.primary] || 'fa-utensils',
              class: ''
            });
          }
          return chips;
        },

        // Helper methods
        getCategoryIcon(category) {
          return categoryIcons[category] || 'fa-location-dot';
        },

        getPlaceIconClass(props) {
          return getPlaceIcon(props.category, props.primary);
        },

        getPlacesInCategory(category) {
          const result = [];
          this.places.forEach((feature, index) => {
            if (feature.properties.category === category) {
              result.push({ feature, index });
            }
          });
          return result.sort((a, b) =>
            a.feature.properties.name.localeCompare(b.feature.properties.name)
          );
        },

        // Actions
        setStatus(status) {
          this.filter.status = status;
          if (window._mapApp) {
            window._mapApp.renderMarkers();
          }
          this.updateHash();
        },

        setCategory(category) {
          this.filter.category = category;
          if (category !== 'Food & Drink') {
            this.filter.primary = 'all';
          }
          if (window._mapApp) {
            window._mapApp.renderMarkers();
          }
          this.updateHash();
        },

        setPrimary(primary) {
          this.filter.primary = primary;
          if (window._mapApp) {
            window._mapApp.renderMarkers();
          }
          this.updateHash();
        },

        clearFilters() {
          this.filter.status = 'all';
          this.filter.category = 'all';
          this.filter.primary = 'all';
          if (window._mapApp) {
            window._mapApp.renderMarkers();
          }
          history.replaceState(null, '', window.location.pathname + window.location.search);
        },

        updateHash() {
          const hash = encodeFilterHash(this.filter);
          history.replaceState(null, '', window.location.pathname + window.location.search + hash);
        },

        toggleFilterPanel() {
          if (this.ui.listSidebarOpen) {
            this.ui.listSidebarOpen = false;
          }
          this.ui.filterPanelOpen = !this.ui.filterPanelOpen;
        },

        closeFilterPanel() {
          this.ui.filterPanelOpen = false;
        },

        toggleListSidebar() {
          if (this.ui.filterPanelOpen) {
            this.ui.filterPanelOpen = false;
          }
          this.ui.listSidebarOpen = !this.ui.listSidebarOpen;
        },

        closeListSidebar() {
          this.ui.listSidebarOpen = false;
        },

        closeAllPanels() {
          this.ui.filterPanelOpen = false;
          this.ui.listSidebarOpen = false;
        },

        jumpToPlace(index) {
          this.closeAllPanels();
          // Reset filters
          this.filter.status = 'all';
          this.filter.category = 'all';
          this.filter.primary = 'all';
          if (window._mapApp) {
            window._mapApp.jumpToPlace(index);
          }
        },

        locateUser() {
          this.ui.locating = true;
          if (window._mapApp) {
            window._mapApp.locateUser();
          }
        }
      });
    });
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.14.3/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.3/dist/cdn.min.js"></script>
</head>
<body x-data="$store.app">
  <div id="map"></div>

  <!-- Error message -->
  <div class="load-error" x-show="ui.loadError" x-cloak>
    <i class="fa-solid fa-triangle-exclamation"></i>
    <span x-text="ui.loadError"></span>
  </div>

  <!-- Overlay for panels -->
  <div class="filter-overlay"
       :class="{ 'visible': ui.filterPanelOpen || ui.listSidebarOpen }"
       @click="closeAllPanels()"></div>

  <!-- List toggle button -->
  <button class="list-toggle-btn"
          :class="{ 'active': ui.listSidebarOpen }"
          @click="toggleListSidebar()"
          title="View all places">
    <i class="fa-solid fa-list"></i>
  </button>

  <!-- List sidebar -->
  <div class="list-sidebar" :class="{ 'expanded': ui.listSidebarOpen }">
    <div class="list-sidebar-header">
      <h2 class="list-sidebar-title">All Places</h2>
      <button class="list-sidebar-close" @click="closeListSidebar()">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div class="list-sidebar-content" id="list-sidebar-content">
      <!-- Categories rendered by Alpine -->
      <template x-for="category in categories" :key="category">
        <div class="list-category" x-data="{ expanded: false }">
          <button class="list-category-header" @click="expanded = !expanded">
            <i class="fa-solid" :class="getCategoryIcon(category)"></i>
            <span class="list-category-title" x-text="category"></span>
            <span class="list-category-count" x-text="getPlacesInCategory(category).length"></span>
            <i class="fa-solid fa-chevron-down list-category-chevron"
               :style="expanded ? 'transform: rotate(180deg)' : ''"></i>
          </button>
          <div class="list-category-items" x-show="expanded" x-collapse>
            <template x-for="item in getPlacesInCategory(category)" :key="item.index">
              <button class="list-item" @click="jumpToPlace(item.index)">
                <div class="list-item-icon"
                     :class="item.feature.properties.status === 'haunts' ? 'haunts' : item.feature.properties.status === 'queue' ? 'queue' : ''">
                  <i class="fa-solid" :class="getPlaceIconClass(item.feature.properties)"></i>
                </div>
                <div class="list-item-content">
                  <div class="list-item-name" x-text="item.feature.properties.name"></div>
                  <div class="list-item-meta" x-text="item.feature.properties.neighborhood || item.feature.properties.category"></div>
                </div>
                <span class="status-badge"
                      x-show="item.feature.properties.status === 'haunts' || item.feature.properties.status === 'queue'"
                      :class="'status-' + item.feature.properties.status"
                      x-text="item.feature.properties.status === 'haunts' ? 'Haunt' : 'Queue'"></span>
              </button>
            </template>
          </div>
        </div>
      </template>
    </div>
  </div>

  <!-- Filter bar -->
  <div class="filter-bar" :class="{ 'expanded': ui.filterPanelOpen }">
    <div class="filter-bar-header" @click="toggleFilterPanel()">
      <div class="filter-bar-toggle">
        <i class="fa-solid fa-sliders"></i>
      </div>
      <span class="filter-bar-title">Filters</span>

      <!-- Collapsed state: show chips -->
      <div class="filter-bar-chips" x-show="!ui.filterPanelOpen">
        <template x-if="filterChips.length === 0">
          <span class="filter-bar-chip">All Places</span>
        </template>
        <template x-for="chip in filterChips" :key="chip.type + chip.value">
          <span class="filter-bar-chip" :class="chip.class">
            <i class="fa-solid" :class="chip.icon"></i>
            <span x-text="chip.label"></span>
          </span>
        </template>
      </div>

      <div class="filter-bar-count" x-show="!ui.filterPanelOpen" x-text="ui.placeCount + ' places'"></div>

      <button class="filter-bar-clear"
              :class="{ 'visible': hasActiveFilters && !ui.filterPanelOpen }"
              @click.stop="clearFilters()"
              title="Clear filters">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <!-- Expanded filter panel -->
    <div class="filter-panel" @click.stop>
      <!-- Status filter -->
      <div class="filter-section">
        <div class="filter-section-header">
          <span class="filter-section-title">Status</span>
        </div>
        <div class="filter-pills">
          <button class="filter-pill"
                  :class="{ 'active': filter.status === 'all' }"
                  @click="setStatus('all')">All</button>
          <button class="filter-pill"
                  :class="{ 'active': filter.status === 'haunts' }"
                  data-status="haunts"
                  @click="setStatus('haunts')">
            <i class="fa-solid fa-heart"></i> Haunts
          </button>
          <button class="filter-pill"
                  :class="{ 'active': filter.status === 'queue' }"
                  data-status="queue"
                  @click="setStatus('queue')">
            <i class="fa-solid fa-bookmark"></i> Queue
          </button>
        </div>
      </div>

      <!-- Category filter -->
      <div class="filter-section">
        <div class="filter-section-header">
          <span class="filter-section-title">Category</span>
        </div>
        <div class="filter-pills">
          <button class="filter-pill"
                  :class="{ 'active': filter.category === 'all' }"
                  @click="setCategory('all')">All</button>
          <template x-for="cat in categories" :key="cat">
            <button class="filter-pill"
                    :class="{ 'active': filter.category === cat }"
                    @click="setCategory(cat)">
              <i class="fa-solid" :class="getCategoryIcon(cat)"></i>
              <span x-text="cat"></span>
            </button>
          </template>
        </div>
      </div>

      <!-- Primary filter (Food & Drink only) -->
      <div class="filter-section primary-section" :class="{ 'visible': showPrimaryFilter }">
        <div class="filter-section-header">
          <span class="filter-section-title">Type</span>
        </div>
        <div class="filter-pills">
          <button class="filter-pill"
                  :class="{ 'active': filter.primary === 'all' }"
                  @click="setPrimary('all')">All</button>
          <button class="filter-pill"
                  :class="{ 'active': filter.primary === 'coffee' }"
                  @click="setPrimary('coffee')">
            <i class="fa-solid fa-mug-hot"></i> Coffee
          </button>
          <button class="filter-pill"
                  :class="{ 'active': filter.primary === 'bar' }"
                  @click="setPrimary('bar')">
            <i class="fa-solid fa-martini-glass"></i> Bar
          </button>
          <button class="filter-pill"
                  :class="{ 'active': filter.primary === 'restaurant' }"
                  @click="setPrimary('restaurant')">
            <i class="fa-solid fa-utensils"></i> Restaurant
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Locate button -->
  <button class="locate-btn"
          :disabled="ui.locating"
          @click="locateUser()"
          title="Find my location">
    <i class="fa-solid" :class="ui.locating ? 'fa-spinner fa-spin' : 'fa-location-crosshairs'"></i>
  </button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script type="module">
    import { init } from './app.js';
    // Initialize the map app (Alpine store is already registered in head)
    init();
  </script>
</body>
</html>
